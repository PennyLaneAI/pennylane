# Copyright 2018-2024 Xanadu Quantum Technologies Inc.

# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at

#     http://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
"""
Tests for the MPSPrep template.
"""

import numpy as np
import pytest

import pennylane as qml


class TestMPSPrep:

    def test_standard_validity(self):
        """Check the operation using the assert_valid function."""
        mps = [
            np.array([[0.0, 0.107], [0.994, 0.0]]),
            np.array(
                [
                    [[0.0, 0.0, 0.0, -0.0], [1.0, 0.0, 0.0, -0.0]],
                    [[0.0, 1.0, 0.0, -0.0], [0.0, 0.0, 0.0, -0.0]],
                ]
            ),
            np.array(
                [
                    [[-1.0, 0.0], [0.0, 0.0]],
                    [[0.0, 0.0], [0.0, 1.0]],
                    [[0.0, -1.0], [0.0, 0.0]],
                    [[0.0, 0.0], [1.0, 0.0]],
                ]
            ),
            np.array([[-1.0, -0.0], [-0.0, -1.0]]),
        ]

        op = qml.MPSPrep(mps, wires=[0, 1, 2, 3], work_wires=[4, 5])
        qml.ops.functions.assert_valid(op, skip_differentiation=True)

    def test_access_to_param(self):
        """tests that the parameter is accessible."""
        mps = [
            np.array([[0.0, 0.107], [0.994, 0.0]]),
            np.array(
                [
                    [[0.0, 0.0, 0.0, -0.0], [1.0, 0.0, 0.0, -0.0]],
                    [[0.0, 1.0, 0.0, -0.0], [0.0, 0.0, 0.0, -0.0]],
                ]
            ),
            np.array(
                [
                    [[-1.0, 0.0], [0.0, 0.0]],
                    [[0.0, 0.0], [0.0, 1.0]],
                    [[0.0, -1.0], [0.0, 0.0]],
                    [[0.0, 0.0], [1.0, 0.0]],
                ]
            ),
            np.array([[-1.0, -0.0], [-0.0, -1.0]]),
        ]
        op = qml.MPSPrep(mps, wires=[0, 1, 2])

        for arr1, arr2 in zip(mps, op.mps):
            assert np.allclose(arr1, arr2)

    @pytest.mark.parametrize(
        ("mps", "msg_match"),
        [
            (
                [
                    np.array([[0.0, 0.107, 0.0], [0.994, 0.0, 0.0]]),
                    np.array(
                        [
                            [[0.0, 0.0, 0.0, -0.0], [1.0, 0.0, 0.0, -0.0]],
                            [[0.0, 1.0, 0.0, -0.0], [0.0, 0.0, 0.0, -0.0]],
                        ]
                    ),
                    np.array(
                        [
                            [[-1.0, 0.0], [0.0, 0.0]],
                            [[0.0, 0.0], [0.0, 1.0]],
                            [[0.0, -1.0], [0.0, 0.0]],
                            [[0.0, 0.0], [1.0, 0.0]],
                        ]
                    ),
                    np.array([[-1.0, -0.0], [-0.0, -1.0]]),
                ],
                "The second dimension of the first tensor must be a power of 2.",
            ),
            (
                [
                    np.array([0.0, 0.107, 0.994, 0.0]),
                    np.array(
                        [
                            [[0.0, 0.0, 0.0, -0.0], [1.0, 0.0, 0.0, -0.0]],
                            [[0.0, 1.0, 0.0, -0.0], [0.0, 0.0, 0.0, -0.0]],
                        ]
                    ),
                    np.array(
                        [
                            [[-1.0, 0.0], [0.0, 0.0]],
                            [[0.0, 0.0], [0.0, 1.0]],
                            [[0.0, -1.0], [0.0, 0.0]],
                            [[0.0, 0.0], [1.0, 0.0]],
                        ]
                    ),
                    np.array([[-1.0, -0.0], [-0.0, -1.0]]),
                ],
                "The first tensor must have exactly 2 dimensions",
            ),
            (
                [
                    np.array([[0.0, 0.107], [0.994, 0.0]]),
                    np.array(
                        [
                            [[0.0, 0.0, 0.0, -0.0], [1.0, 0.0, 0.0, -0.0]],
                            [[0.0, 1.0, 0.0, -0.0], [0.0, 0.0, 0.0, -0.0]],
                        ]
                    ),
                    np.array(
                        [[-1.0, 0.0], [0.0, 0.0]],
                    ),
                    np.array([[-1.0, -0.0], [-0.0, -1.0]]),
                ],
                "Tensor 2 must have exactly 3 dimensions.",
            ),
            (
                [
                    np.array([[0.0, 0.107], [0.994, 0.0]]),
                    np.array(
                        [
                            [[0.0, 0.0, 0.0, -0.0], [1.0, 0.0, 0.0, -0.0]],
                            [[0.0, 1.0, 0.0, -0.0], [0.0, 0.0, 0.0, -0.0]],
                        ]
                    ),
                    np.array(
                        [
                            [[-1.0, 0.0, 0.0], [0.0, 0.0, 0.0]],
                            [[0.0, 0.0, 0.0], [0.0, 1.0, 0.0]],
                            [[0.0, -1.0, 0.0], [0.0, 0.0, 0.0]],
                        ]
                    ),
                    np.array([[-1.0, -0.0], [-0.0, -1.0]]),
                ],
                "The first dimension of tensor 2 must be a power of 2.",
            ),
            (
                [
                    np.array([[0.0, 0.107], [0.994, 0.0]]),
                    np.array(
                        [
                            [[-1.0, 0.0], [0.0, 0.0]],
                            [[0.0, 0.0], [0.0, 1.0]],
                            [[0.0, -1.0], [0.0, 0.0]],
                            [[0.0, 0.0], [1.0, 0.0]],
                        ]
                    ),
                    np.array(
                        [
                            [[-1.0, 0.0], [0.0, 0.0]],
                            [[0.0, 0.0], [0.0, 1.0]],
                            [[0.0, -1.0], [0.0, 0.0]],
                            [[0.0, 0.0], [1.0, 0.0]],
                        ]
                    ),
                    np.array([[-1.0, -0.0], [-0.0, -1.0]]),
                ],
                "Dimension mismatch:",
            ),
            (
                [
                    np.array([[0.0, 0.107], [0.994, 0.0]]),
                    np.array(
                        [
                            [[0.0, 0.0, 0.0, -0.0], [1.0, 0.0, 0.0, -0.0]],
                            [[0.0, 1.0, 0.0, -0.0], [0.0, 0.0, 0.0, -0.0]],
                        ]
                    ),
                    np.array(
                        [
                            [[-1.0, 0.0], [0.0, 0.0]],
                            [[0.0, 0.0], [0.0, 1.0]],
                            [[0.0, -1.0], [0.0, 0.0]],
                            [[0.0, 0.0], [1.0, 0.0]],
                        ]
                    ),
                    np.array([-1.0, -0.0, -0.0, -1.0]),
                ],
                "The last tensor must have exactly 2 dimensions.",
            ),
            (
                [
                    np.array([[0.0, 0.107], [0.994, 0.0]]),
                    np.array(
                        [
                            [[0.0, 0.0, 0.0, -0.0], [1.0, 0.0, 0.0, -0.0]],
                            [[0.0, 1.0, 0.0, -0.0], [0.0, 0.0, 0.0, -0.0]],
                        ]
                    ),
                    np.array(
                        [
                            [[-1.0, 0.0], [0.0, 0.0]],
                            [[0.0, 0.0], [0.0, 1.0]],
                            [[0.0, -1.0], [0.0, 0.0]],
                            [[0.0, 0.0], [1.0, 0.0]],
                        ]
                    ),
                    np.array([[-1.0, -0.0, 0.0], [-0.0, -1.0, 0.0]]),
                ],
                "The second dimension of the last tensor must be exactly 2.",
            ),
        ],
    )
    def test_MPSPrep_error(self, mps, msg_match):
        """Test that proper errors are raised for MPSPrep"""
        with pytest.raises(AssertionError, match=msg_match):
            qml.MPSPrep(mps, wires=[0, 1, 2])

    @pytest.mark.jax
    def test_jax_mps(self):
        """Check the operation works with jax."""

        import jax
        from jax import numpy as jnp

        mps = [
            jnp.array([[0.0, 0.107j], [0.994, 0.0]]),
            jnp.array(
                [
                    [[0.0, 0.0], [1.0, 0.0]],
                    [[0.0, 1.0], [0.0, 0.0]],
                ]
            ),
            jnp.array([[-1.0, -0.0], [-0.0, -1.0]]),
        ]

        dev = qml.device("default.qubit")

        @qml.qnode(dev)
        def circuit():
            qml.MPSPrep(mps, wires=range(2, 5), work_wires=[0, 1])
            return qml.state()

        output = circuit()[:8]

        state = [
            0.0 + 0.0j,
            -0.10705513j,
            0.0 + 0.0j,
            0.0 + 0.0j,
            0.0 + 0.0j,
            0.0 + 0.0j,
            -0.99451217 + 0.0j,
            0.0 + 0.0j,
        ]

        assert jax.numpy.allclose(output, jax.numpy.array(state), rtol=0.01)

    @pytest.mark.parametrize(
        ("mps", "state", "num_wires", "num_work_wires"),
        [
            (
                [
                    np.array([[0.70710678, 0.0], [0.0, 0.70710678]]),
                    np.array(
                        [
                            [[0.0, 1.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0]],
                            [[0.0, 0.0, -0.0, 0.0], [-1.0, 0.0, 0.0, 0.0]],
                        ]
                    ),
                    np.array(
                        [
                            [[0.00000000e00, 1.74315280e-32], [-7.07106781e-01, -7.07106781e-01]],
                            [[7.07106781e-01, 7.07106781e-01], [0.00000000e00, 0.00000000e00]],
                            [[0.00000000e00, 0.00000000e00], [-7.07106781e-01, 7.07106781e-01]],
                            [[-7.07106781e-01, 7.07106781e-01], [0.00000000e00, 0.00000000e00]],
                        ]
                    ),
                    np.array([[1.0, 0.0], [0.0, 1.0]]),
                ],
                np.array([1 / 2, 1 / 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1 / 2, 1 / 2]),
                4, 2
            ),
            (
                [
                    np.array([[0.53849604, -0.44389787], [-0.59116842, -0.40434711]]),
                    np.array(
                        [
                            [
                                [-6.05052107e-01, 1.34284016e-01, -2.84018989e-01, -1.12416345e-01],
                                [3.60988555e-01, 6.14571922e-01, -1.20681653e-01, -2.89527967e-04],
                            ],
                            [
                                [-1.12393068e-01, 2.11496619e-01, 3.99193070e-01, -3.44891522e-01],
                                [-5.99232567e-01, 3.76491467e-01, 3.04813277e-01, 2.65697349e-01],
                            ],
                        ]
                    ),
                    np.array(
                        [
                            [
                                [0.87613189, -0.34254341, -0.12704983, -0.0161698],
                                [-0.20758717, 0.1329479, -0.18184107, 0.06942658],
                            ],
                            [
                                [-0.16499137, -0.13680142, -0.18432824, 0.12950892],
                                [-0.68790868, -0.64141472, -0.12485688, -0.0556177],
                            ],
                            [
                                [0.0352582, -0.37993402, 0.26781956, -0.25935129],
                                [0.04351872, -0.27109361, 0.65111429, 0.4648453],
                            ],
                            [
                                [0.1909576, 0.25461839, -0.07463641, -0.34390477],
                                [-0.21279487, 0.0305474, 0.53420894, -0.66578494],
                            ],
                        ]
                    ),
                    np.array(
                        [
                            [[-0.26771292, -0.00628612], [-0.96316273, 0.02465422]],
                            [[0.96011241, 0.07601506], [-0.2663889, 0.03798452]],
                            [[-0.00727353, 0.4537835], [-0.02374101, -0.89076596]],
                            [[0.08038064, -0.88784161], [-0.02812246, -0.45220057]],
                        ]
                    ),
                    np.array([[-0.97855153, 0.2060022], [0.2060022, 0.97855153]]),
                ],
                np.array(
                    [
                        -0.30838839,
                        0.00913474,
                        -0.14842667,
                        0.06058075,
                        -0.00464704,
                        0.16533888,
                        0.08806463,
                        0.19535211,
                        0.17301488,
                        -0.20745747,
                        0.30696199,
                        0.01131135,
                        -0.08844845,
                        -0.12525685,
                        -0.13280471,
                        0.29048878,
                        0.19283544,
                        0.02670539,
                        0.39244675,
                        0.00316343,
                        -0.12347408,
                        0.15527045,
                        0.02744977,
                        -0.01096892,
                        -0.01303293,
                        0.06124989,
                        0.08509908,
                        -0.08363092,
                        -0.24638746,
                        -0.00924703,
                        0.44259161,
                        -0.07738196,
                    ]
                ),
                5, 2
            ),
            (
                [
                    np.array([[0.0, 0.107], [0.994, 0.0]]),
                    np.array(
                        [
                            [[0.0, 0.0], [1.0, 0.0]],
                            [[0.0, 1.0], [0.0, 0.0]],
                        ]
                    ),
                    np.array([[-1.0, -0.0], [-0.0, -1.0]]),
                ],
                np.array(
                    [
                        0.0 + 0.0j,
                        -0.10705513 + 0.0j,
                        0.0 + 0.0j,
                        0.0 + 0.0j,
                        0.0 + 0.0j,
                        0.0 + 0.0j,
                        -0.99451217 + 0.0j,
                        0.0 + 0.0j,
                    ]
                ),
                3, 2
            ),
            (
                [
                    np.array([[-0.64374691, 0.25783089], [-0.67757545, -0.24495846]]),
                    np.array(
                        [
                            [
                                [-0.72665953, 0.01695629, 0.04022508, 0.13077263],
                                [-0.65546788, -0.01803, -0.04375225, -0.14519433],
                            ],
                            [
                                [0.00731574, 0.25563843, 0.58869135, -0.13557481],
                                [0.00222735, 0.72112356, -0.22277841, 0.00175324],
                            ],
                        ]
                    ),
                    np.array(
                        [
                            [
                                [
                                    -6.91492013e-01,
                                    -7.40733593e-03,
                                    8.32203456e-02,
                                    -1.31925808e-02,
                                    8.32172562e-02,
                                    -4.20979068e-03,
                                    -2.91059929e-02,
                                    -2.30342749e-02,
                                ],
                                [
                                    -7.01331761e-01,
                                    4.68776263e-03,
                                    -7.88104668e-02,
                                    9.91343455e-03,
                                    -8.08022002e-02,
                                    6.63371222e-03,
                                    3.14977352e-02,
                                    2.45152687e-02,
                                ],
                            ],
                            [
                                [
                                    1.26334685e-02,
                                    -5.40601054e-01,
                                    -2.47798554e-02,
                                    -2.66385634e-01,
                                    -9.17867375e-02,
                                    1.96562489e-02,
                                    -2.03767541e-01,
                                    1.46719628e-01,
                                ],
                                [
                                    -9.03610139e-03,
                                    -5.67575515e-01,
                                    -2.14929678e-01,
                                    3.84806902e-01,
                                    2.11554073e-01,
                                    -1.13786774e-02,
                                    5.02041735e-02,
                                    -1.60225215e-02,
                                ],
                            ],
                            [
                                [
                                    -2.17526010e-02,
                                    2.72346269e-01,
                                    -5.70940446e-01,
                                    -2.22100761e-01,
                                    2.76411944e-01,
                                    1.80746415e-01,
                                    -1.03163232e-01,
                                    -6.88729213e-02,
                                ],
                                [
                                    9.54095817e-04,
                                    -3.78940751e-01,
                                    -9.14411476e-02,
                                    -3.78619253e-01,
                                    -8.35224402e-02,
                                    -1.66613450e-01,
                                    1.49532915e-01,
                                    -2.70529989e-01,
                                ],
                            ],
                            [
                                [
                                    -1.23672581e-01,
                                    8.13222976e-02,
                                    -1.07497685e-01,
                                    3.49746937e-01,
                                    -3.78349040e-01,
                                    -4.87436535e-02,
                                    -3.42885989e-01,
                                    -2.68040079e-01,
                                ],
                                [
                                    7.17375269e-02,
                                    -2.79172775e-01,
                                    2.54118019e-01,
                                    1.75648766e-04,
                                    -1.50192946e-01,
                                    5.59918376e-01,
                                    8.93483436e-02,
                                    -1.32527485e-01,
                                ],
                            ],
                        ]
                    ),
                    np.array(
                        [
                            [
                                [
                                    -7.26956900e-01,
                                    -5.18896982e-02,
                                    -7.97032140e-02,
                                    -1.80635403e-02,
                                    1.48630173e-02,
                                    2.90843326e-02,
                                    8.83787396e-03,
                                    1.53676201e-03,
                                    -8.63529646e-03,
                                    2.78648508e-02,
                                    -2.18321042e-03,
                                    -1.04170626e-02,
                                    3.07192054e-03,
                                    -2.03111001e-03,
                                    4.03240959e-03,
                                    -8.93480327e-04,
                                ],
                                [
                                    -6.68880411e-01,
                                    3.93578672e-02,
                                    9.26796070e-02,
                                    1.29884335e-02,
                                    -4.89489768e-03,
                                    -3.18938239e-02,
                                    -5.56450986e-03,
                                    -5.69835147e-03,
                                    2.58140286e-03,
                                    -3.05635877e-02,
                                    1.68306438e-03,
                                    1.55374956e-02,
                                    -1.51667395e-03,
                                    5.44864185e-04,
                                    -4.17174679e-03,
                                    1.45711612e-03,
                                ],
                            ],
                            [
                                [
                                    2.25739575e-01,
                                    -4.42152760e-03,
                                    4.13935421e-01,
                                    -3.85927702e-01,
                                    1.80788710e-01,
                                    1.36554550e-02,
                                    6.34438371e-02,
                                    2.00241142e-02,
                                    -1.31484176e-01,
                                    4.54858786e-02,
                                    -6.11252816e-02,
                                    -2.32510928e-02,
                                    -1.07805808e-02,
                                    -2.95916670e-02,
                                    6.73816920e-03,
                                    7.35638225e-04,
                                ],
                                [
                                    -2.36925007e-01,
                                    6.93534258e-01,
                                    1.57326411e-02,
                                    -2.98309191e-02,
                                    -4.18016999e-02,
                                    -3.06325924e-03,
                                    -8.23531596e-02,
                                    2.07652566e-02,
                                    2.96882029e-02,
                                    1.18268296e-01,
                                    4.57240293e-02,
                                    -4.06328704e-02,
                                    -2.71282667e-02,
                                    6.74785667e-03,
                                    1.21245231e-02,
                                    9.22160365e-04,
                                ],
                            ],
                            [
                                [
                                    7.94648592e-02,
                                    1.01076924e-01,
                                    -9.38246732e-02,
                                    -3.97725769e-01,
                                    1.53388297e-01,
                                    3.39989160e-01,
                                    6.27273838e-02,
                                    -1.20820509e-02,
                                    1.06119574e-01,
                                    -3.65594210e-03,
                                    8.92916138e-02,
                                    1.42977146e-01,
                                    2.94984256e-02,
                                    4.69841544e-02,
                                    -1.40509363e-02,
                                    2.14227839e-03,
                                ],
                                [
                                    -1.36149819e-02,
                                    -2.59828059e-01,
                                    5.30982869e-01,
                                    3.31280264e-01,
                                    -2.02773457e-01,
                                    2.80548897e-01,
                                    -3.52751023e-02,
                                    -2.45050207e-02,
                                    -5.89364516e-02,
                                    2.07938437e-01,
                                    3.48180664e-02,
                                    1.26705562e-03,
                                    -1.43371005e-02,
                                    3.29627571e-02,
                                    -5.23975387e-03,
                                    2.90084874e-03,
                                ],
                            ],
                            [
                                [
                                    -1.85318574e-01,
                                    1.72148342e-02,
                                    3.07673499e-02,
                                    -3.06891115e-02,
                                    -1.04694544e-01,
                                    6.64563470e-02,
                                    3.74628726e-01,
                                    6.86689197e-02,
                                    2.35043996e-01,
                                    -1.70333726e-02,
                                    -1.11167776e-01,
                                    -9.50772373e-02,
                                    -1.08964675e-01,
                                    2.48494258e-02,
                                    -6.89870222e-03,
                                    7.72365145e-03,
                                ],
                                [
                                    1.98230249e-01,
                                    1.92226583e-01,
                                    -8.51125273e-02,
                                    4.85935446e-01,
                                    5.97275969e-01,
                                    1.22966905e-01,
                                    1.15601680e-01,
                                    3.61592471e-02,
                                    -5.70874123e-02,
                                    8.29098693e-03,
                                    -3.15317785e-02,
                                    4.57836894e-02,
                                    -8.87319010e-03,
                                    -2.60788502e-02,
                                    1.67362095e-03,
                                    1.29146695e-02,
                                ],
                            ],
                            [
                                [
                                    1.50718538e-01,
                                    -3.73662397e-01,
                                    1.09481561e-01,
                                    -8.04912808e-02,
                                    2.18375991e-01,
                                    -3.97626731e-01,
                                    5.57431158e-02,
                                    -8.31548122e-02,
                                    2.04749137e-01,
                                    1.93261411e-01,
                                    1.81664278e-01,
                                    4.41249772e-02,
                                    -4.31997377e-02,
                                    -9.41905879e-03,
                                    1.16629475e-02,
                                    9.38347718e-03,
                                ],
                                [
                                    -1.52688567e-01,
                                    -2.54442763e-01,
                                    1.32312406e-01,
                                    -6.16227897e-02,
                                    3.40522534e-01,
                                    1.12273377e-01,
                                    -4.20234248e-01,
                                    1.16738771e-01,
                                    1.17229999e-01,
                                    -1.39675701e-01,
                                    1.28962473e-02,
                                    -1.28284178e-01,
                                    -7.92197042e-02,
                                    5.09632170e-02,
                                    9.03859113e-03,
                                    1.87038371e-03,
                                ],
                            ],
                            [
                                [
                                    9.86788200e-02,
                                    -4.78964808e-02,
                                    -4.93369395e-01,
                                    -1.98408788e-01,
                                    -3.72783770e-02,
                                    -2.13353018e-01,
                                    -2.69308465e-02,
                                    -3.04939822e-02,
                                    -4.04526292e-01,
                                    8.52715509e-02,
                                    8.69936068e-03,
                                    -5.15550899e-02,
                                    -8.03106921e-02,
                                    9.08182999e-02,
                                    -3.85470923e-02,
                                    3.09554294e-02,
                                ],
                                [
                                    -3.53892200e-02,
                                    1.10476882e-01,
                                    4.21363847e-02,
                                    9.73795760e-03,
                                    1.94766292e-01,
                                    1.59650508e-01,
                                    1.27667812e-01,
                                    -5.18957267e-01,
                                    -2.11794692e-02,
                                    -8.83564369e-02,
                                    1.83174581e-01,
                                    -2.38243633e-01,
                                    9.71534395e-03,
                                    -3.53255244e-02,
                                    -3.80156177e-02,
                                    -1.07151815e-02,
                                ],
                            ],
                            [
                                [
                                    -1.45796464e-01,
                                    1.24260665e-01,
                                    2.54484692e-01,
                                    1.49779986e-01,
                                    4.03725073e-01,
                                    -3.51692726e-01,
                                    2.62238052e-01,
                                    1.36718006e-02,
                                    -5.56143979e-02,
                                    5.29696080e-02,
                                    -6.36145420e-02,
                                    -5.45618916e-02,
                                    1.45468039e-01,
                                    1.75422048e-01,
                                    7.06805117e-03,
                                    -3.18021526e-02,
                                ],
                                [
                                    1.44310437e-01,
                                    -3.58636980e-02,
                                    1.60261486e-01,
                                    5.50123128e-02,
                                    -2.31925988e-01,
                                    1.13621650e-01,
                                    3.23918766e-01,
                                    9.98053689e-03,
                                    -2.18636535e-01,
                                    -3.33481395e-01,
                                    2.52038073e-01,
                                    -3.27563738e-02,
                                    7.17576987e-03,
                                    4.04534756e-02,
                                    8.00494465e-02,
                                    1.74029012e-02,
                                ],
                            ],
                            [
                                [
                                    -1.46922060e-01,
                                    -3.57370338e-02,
                                    7.94313626e-02,
                                    -5.52551940e-03,
                                    -6.49142661e-03,
                                    -1.34455428e-02,
                                    1.42722333e-01,
                                    7.14544248e-01,
                                    1.06363753e-03,
                                    1.96892300e-02,
                                    2.43739162e-01,
                                    -1.73862548e-01,
                                    1.54730683e-01,
                                    -4.89757373e-02,
                                    -4.67053458e-02,
                                    3.33308995e-03,
                                ],
                                [
                                    1.70682117e-01,
                                    1.60337315e-02,
                                    1.05085861e-01,
                                    -1.05913231e-01,
                                    -6.86987090e-02,
                                    1.16503002e-02,
                                    -1.35662214e-01,
                                    -2.19188968e-01,
                                    2.43799882e-01,
                                    4.10914579e-02,
                                    -1.66618047e-01,
                                    -1.25229820e-01,
                                    3.02082948e-01,
                                    1.22218048e-02,
                                    1.44718604e-02,
                                    4.39895289e-02,
                                ],
                            ],
                        ]
                    ),
                    np.array(
                        [
                            [
                                [
                                    -7.39215185e-01,
                                    1.51191359e-02,
                                    -2.63764688e-02,
                                    6.03661036e-02,
                                    -5.09975545e-03,
                                    3.26523535e-02,
                                    -1.64465999e-02,
                                    -1.76173052e-02,
                                ],
                                [
                                    -6.63570431e-01,
                                    -1.03922974e-02,
                                    2.39957405e-02,
                                    -6.37631532e-02,
                                    6.96323082e-04,
                                    -3.93988150e-02,
                                    2.06397213e-02,
                                    1.62939216e-02,
                                ],
                            ],
                            [
                                [
                                    9.22334915e-04,
                                    -3.83702363e-01,
                                    -1.85916245e-01,
                                    4.71465147e-01,
                                    2.28629105e-01,
                                    -2.21331270e-01,
                                    2.15468318e-01,
                                    -2.90246366e-02,
                                ],
                                [
                                    4.28036153e-02,
                                    -4.93487355e-01,
                                    3.98179100e-01,
                                    -7.42179842e-02,
                                    7.30577130e-02,
                                    5.39563598e-02,
                                    -1.04677199e-01,
                                    -1.37028208e-01,
                                ],
                            ],
                            [
                                [
                                    1.53020830e-01,
                                    5.51662953e-01,
                                    -1.57679916e-01,
                                    -1.33194376e-01,
                                    2.89143849e-01,
                                    -2.28965240e-03,
                                    -2.96165310e-03,
                                    4.30650074e-02,
                                ],
                                [
                                    -1.42422822e-01,
                                    -5.91165381e-01,
                                    -2.72758694e-01,
                                    -2.36879983e-01,
                                    5.51031340e-02,
                                    -2.48205545e-03,
                                    -7.28485600e-02,
                                    1.88564345e-01,
                                ],
                            ],
                            [
                                [
                                    2.80702661e-01,
                                    -4.68465814e-03,
                                    -4.59419969e-01,
                                    -2.82173740e-01,
                                    -1.05531239e-01,
                                    -2.58404344e-01,
                                    -2.20615654e-02,
                                    -2.91802704e-01,
                                ],
                                [
                                    -2.82062055e-01,
                                    2.58831173e-01,
                                    2.71699061e-01,
                                    -2.47187375e-01,
                                    3.50153452e-01,
                                    -2.41781084e-01,
                                    -6.28408551e-02,
                                    -2.14732912e-02,
                                ],
                            ],
                            [
                                [
                                    5.65776089e-02,
                                    5.67531880e-01,
                                    3.37075119e-02,
                                    2.30082061e-01,
                                    -3.16954239e-01,
                                    -2.12476016e-01,
                                    -5.96491295e-04,
                                    5.27790075e-02,
                                ],
                                [
                                    -2.58716466e-02,
                                    -6.72997344e-03,
                                    5.04253165e-01,
                                    1.68461021e-01,
                                    -3.94738586e-01,
                                    -1.55382690e-01,
                                    9.42255021e-02,
                                    5.89740962e-03,
                                ],
                            ],
                            [
                                [
                                    3.28011151e-02,
                                    8.65141066e-02,
                                    5.38106131e-02,
                                    -1.56318574e-01,
                                    7.20072018e-02,
                                    7.58285940e-01,
                                    3.41646990e-01,
                                    -1.02373340e-01,
                                ],
                                [
                                    1.40337760e-02,
                                    -2.58713894e-02,
                                    4.39370027e-01,
                                    -1.59318615e-01,
                                    7.70471811e-02,
                                    4.76469298e-02,
                                    1.70724734e-01,
                                    -8.63698317e-03,
                                ],
                            ],
                            [
                                [
                                    1.83634885e-02,
                                    -1.50017754e-01,
                                    -4.04259198e-01,
                                    -2.74322931e-01,
                                    -4.61943157e-01,
                                    4.79160444e-02,
                                    3.56186141e-01,
                                    2.47069016e-01,
                                ],
                                [
                                    -6.12918867e-02,
                                    -1.98952677e-01,
                                    -2.08372801e-01,
                                    -1.13144466e-02,
                                    -3.45425959e-01,
                                    1.04551100e-01,
                                    -2.38997692e-02,
                                    -3.42304636e-01,
                                ],
                            ],
                            [
                                [
                                    4.22745149e-01,
                                    8.61817627e-02,
                                    2.05308927e-01,
                                    3.31492388e-01,
                                    -1.91431480e-02,
                                    -4.36609007e-02,
                                    3.19242072e-01,
                                    2.38746274e-01,
                                ],
                                [
                                    -4.95576485e-01,
                                    2.15604243e-01,
                                    -1.40636931e-01,
                                    4.77619381e-02,
                                    2.19670268e-01,
                                    3.50742485e-01,
                                    9.94209760e-02,
                                    -7.30152475e-02,
                                ],
                            ],
                            [
                                [
                                    1.03779499e-01,
                                    -1.03011533e-01,
                                    -1.21759080e-01,
                                    2.47597438e-01,
                                    -7.89116089e-02,
                                    1.02299422e-01,
                                    -4.32982831e-01,
                                    9.28544960e-02,
                                ],
                                [
                                    -1.72226792e-02,
                                    -4.85779985e-02,
                                    -9.08556359e-02,
                                    -4.19828425e-01,
                                    -8.23879645e-02,
                                    -7.08564077e-02,
                                    6.83747067e-01,
                                    -1.52364094e-01,
                                ],
                            ],
                            [
                                [
                                    -5.63508809e-02,
                                    2.44684020e-02,
                                    -4.00428804e-01,
                                    4.66261038e-02,
                                    -1.64762601e-01,
                                    1.92655220e-01,
                                    -2.65209952e-01,
                                    4.02145626e-01,
                                ],
                                [
                                    5.11876871e-02,
                                    -1.06530914e-01,
                                    1.15508085e-01,
                                    4.94868315e-01,
                                    4.44289864e-01,
                                    9.77517925e-02,
                                    8.09029570e-02,
                                    2.27351086e-01,
                                ],
                            ],
                            [
                                [
                                    -1.56695617e-02,
                                    -1.82116665e-01,
                                    4.43545155e-01,
                                    -4.00997846e-01,
                                    -3.12558571e-01,
                                    -2.75361000e-01,
                                    -5.89232994e-02,
                                    2.28496997e-01,
                                ],
                                [
                                    -2.22087536e-02,
                                    -2.64708282e-01,
                                    2.72021753e-01,
                                    -2.54991248e-01,
                                    1.47714067e-01,
                                    2.42181067e-01,
                                    1.01830571e-01,
                                    2.81844604e-01,
                                ],
                            ],
                            [
                                [
                                    2.46109085e-01,
                                    -1.76396647e-01,
                                    -3.38287202e-02,
                                    2.04381052e-01,
                                    -2.48929130e-01,
                                    3.30308907e-01,
                                    -3.99637345e-01,
                                    -1.19951604e-01,
                                ],
                                [
                                    -2.29902279e-01,
                                    -4.57018542e-02,
                                    3.36198260e-02,
                                    -1.49935015e-01,
                                    -2.82781631e-01,
                                    1.61951016e-01,
                                    -5.12814220e-01,
                                    2.69265556e-01,
                                ],
                            ],
                            [
                                [
                                    -1.14896440e-01,
                                    1.75527902e-01,
                                    2.31253736e-01,
                                    2.67301186e-01,
                                    -4.97053145e-01,
                                    1.13962297e-01,
                                    2.81716038e-02,
                                    -9.34293505e-02,
                                ],
                                [
                                    1.74031657e-01,
                                    -1.49449689e-01,
                                    -1.68821568e-01,
                                    -1.86713911e-01,
                                    4.76349343e-01,
                                    -2.66422715e-01,
                                    -2.36597421e-01,
                                    -3.02713560e-01,
                                ],
                            ],
                            [
                                [
                                    -2.72722440e-01,
                                    2.66563711e-01,
                                    -2.58870949e-01,
                                    1.10283735e-01,
                                    3.15934741e-02,
                                    -9.54369033e-02,
                                    -9.37724252e-03,
                                    1.07174625e-01,
                                ],
                                [
                                    3.19520898e-01,
                                    3.10382389e-01,
                                    7.74617018e-02,
                                    -4.13753405e-01,
                                    5.15695312e-02,
                                    5.90222992e-01,
                                    -1.60930757e-01,
                                    -3.41258392e-02,
                                ],
                            ],
                            [
                                [
                                    6.81083862e-02,
                                    2.92289205e-02,
                                    1.38734883e-01,
                                    -1.80587247e-01,
                                    3.03861976e-01,
                                    6.23088823e-02,
                                    -2.96331139e-01,
                                    5.46041542e-01,
                                ],
                                [
                                    -1.00557818e-01,
                                    6.89650852e-02,
                                    2.15651050e-01,
                                    -8.28205554e-02,
                                    -1.10203337e-02,
                                    -1.77841319e-01,
                                    -3.06522791e-01,
                                    -5.16257599e-01,
                                ],
                            ],
                            [
                                [
                                    3.23231606e-02,
                                    1.02309723e-01,
                                    8.00982023e-02,
                                    -1.78680470e-01,
                                    -1.15906512e-02,
                                    -1.83176237e-02,
                                    -3.12432732e-01,
                                    -4.74569116e-01,
                                ],
                                [
                                    -9.49855310e-02,
                                    -2.09317360e-01,
                                    6.64475329e-02,
                                    3.08992976e-01,
                                    6.35108940e-02,
                                    4.75688276e-01,
                                    8.74253497e-02,
                                    -4.85964466e-01,
                                ],
                            ],
                        ]
                    ),
                    np.array(
                        [
                            [
                                [
                                    -7.22095087e-01,
                                    -1.01164879e-02,
                                    -1.10984651e-02,
                                    -1.51668501e-03,
                                ],
                                [-6.91561481e-01, -6.09360196e-03, 4.91604761e-05, -7.51327286e-03],
                            ],
                            [
                                [4.73695093e-01, -5.82170166e-01, -3.60666152e-01, 4.26996650e-02],
                                [-4.83139626e-01, -1.75978052e-02, 7.88868070e-04, 2.66558283e-01],
                            ],
                            [
                                [-5.56273463e-02, -2.76829795e-01, 2.66697060e-01, -5.33480239e-01],
                                [6.54970136e-02, -7.47440736e-01, -3.85221274e-02, 1.00453014e-02],
                            ],
                            [
                                [-1.39221572e-01, -5.47585195e-01, 6.80314751e-01, 2.26898973e-01],
                                [1.36971811e-01, 3.13226910e-01, -8.73675609e-02, 2.04819528e-01],
                            ],
                            [
                                [-2.59816758e-01, -2.80491662e-01, -2.38699941e-01, 2.36784842e-01],
                                [2.80236008e-01, -1.47845851e-01, 8.00080476e-01, -1.59866618e-02],
                            ],
                            [
                                [8.18034481e-03, 3.33676450e-01, 9.82856024e-02, -2.66612875e-01],
                                [-2.44925558e-02, 9.64807223e-02, 2.71277131e-01, 8.51088084e-01],
                            ],
                            [
                                [1.83494980e-02, 1.90161167e-01, 6.41419453e-02, 7.27388798e-01],
                                [-2.26839882e-02, -5.55396596e-01, -2.12684284e-01, 2.75823905e-01],
                            ],
                            [
                                [4.04729819e-01, 2.41483866e-01, 5.14868292e-01, 7.64603044e-02],
                                [-4.30837574e-01, -5.69397002e-02, 4.81588701e-01, -2.93518242e-01],
                            ],
                        ]
                    ),
                    np.array(
                        [
                            [[-0.69855659, -0.02547459], [-0.71472011, 0.02334298]],
                            [[0.06554284, -0.77209633], [-0.01590235, 0.63191654]],
                            [[-0.57351651, 0.33877375], [0.56439712, 0.48761363]],
                            [[0.42284943, 0.53707601], [-0.4127689, 0.60197139]],
                        ]
                    ),
                    np.array([[-0.71713694, -0.69693229], [-0.69693229, 0.71713694]]),
                ],
                [
                    np.array(
                        [
                            0.08085144,
                            0.09761696,
                            0.10213486,
                            0.03591738,
                            0.09834863,
                            0.02217105,
                            0.06285928,
                            0.03074809,
                            0.0740198,
                            0.0698003,
                            0.05332626,
                            0.08263967,
                            0.08339373,
                            0.0582516,
                            0.03444937,
                            0.04097518,
                            0.07885712,
                            0.08250019,
                            0.07141634,
                            0.00820652,
                            0.02971197,
                            0.09263727,
                            0.04174775,
                            0.06073331,
                            0.01480508,
                            0.0353958,
                            0.0416491,
                            0.07948824,
                            0.00226247,
                            0.02022389,
                            0.02734497,
                            0.02051584,
                            0.00252361,
                            0.03177328,
                            0.08170036,
                            0.05228815,
                            0.08533036,
                            0.01794431,
                            0.03351122,
                            0.05938944,
                            0.06271116,
                            0.00550878,
                            0.0792033,
                            0.07935452,
                            0.10020191,
                            0.0861573,
                            0.06714553,
                            0.01574152,
                            0.09015536,
                            0.09154584,
                            0.00485848,
                            0.04496208,
                            0.06380167,
                            0.0575385,
                            0.08096828,
                            0.07414622,
                            0.05218791,
                            0.07280432,
                            0.10046548,
                            0.0712063,
                            0.03209078,
                            0.01009034,
                            0.03968934,
                            0.08978249,
                            0.05620439,
                            0.01476133,
                            0.01004164,
                            0.02132678,
                            0.06698965,
                            0.08060808,
                            0.06735605,
                            0.10231793,
                            0.05668154,
                            0.03289802,
                            0.08073365,
                            0.05406215,
                            0.02940096,
                            0.08332548,
                            0.04913402,
                            0.01493699,
                            0.10539111,
                            0.05015119,
                            0.07470779,
                            0.04500437,
                            0.03644147,
                            0.02557294,
                            0.02633899,
                            0.08874942,
                            0.0209871,
                            0.0837202,
                            0.08289899,
                            0.08655099,
                            0.03574565,
                            0.02585511,
                            0.0216522,
                            0.04021185,
                            0.02110535,
                            0.00864147,
                            0.01661313,
                            0.06708803,
                            0.09837143,
                            0.00843592,
                            0.06203284,
                            0.04006137,
                            0.02605926,
                            0.02466366,
                            0.08820421,
                            0.04647546,
                            0.028891,
                            0.04143445,
                            0.03665643,
                            0.04122692,
                            0.10364932,
                            0.0518044,
                            0.09284939,
                            0.08407832,
                            0.02570849,
                            0.0078164,
                            0.09753967,
                            0.06562607,
                            0.06180316,
                            0.08432209,
                            0.0971208,
                            0.0450395,
                            0.01926085,
                            0.01673371,
                            0.10561198,
                            0.01798062,
                            0.06940313,
                            0.09693075,
                            0.04626718,
                            0.0657991,
                            0.03805738,
                            0.03380537,
                            0.03504716,
                            0.09076226,
                            0.09972662,
                            0.00147235,
                            0.01705157,
                            0.07318936,
                            0.04494864,
                            0.05730511,
                            0.0969362,
                            0.04059149,
                            0.07589099,
                            0.0106066,
                            0.1049664,
                            0.08049863,
                            0.00441365,
                            0.03834135,
                            0.00821969,
                            0.07525507,
                            0.06558401,
                            0.05313543,
                            0.08709741,
                            0.08236989,
                            0.06805699,
                            0.10147663,
                            0.03278366,
                            0.03803273,
                            0.02855612,
                            0.09715493,
                            0.06446774,
                            0.08907626,
                            0.02357126,
                            0.07635632,
                            0.04005535,
                            0.06329127,
                            0.08562929,
                            0.02110783,
                            0.02647078,
                            0.09907529,
                            0.09797442,
                            0.071256,
                            0.06933264,
                            0.0871932,
                            0.03860151,
                            0.09494139,
                            0.00250485,
                            0.07164905,
                            0.10049224,
                            0.03726186,
                            0.06174655,
                            0.10628715,
                            0.0330398,
                            0.04238587,
                            0.02770868,
                            0.00966496,
                            0.04265765,
                            0.08752316,
                            0.09132769,
                            0.0295163,
                            0.06551486,
                            0.07988889,
                            0.10570001,
                            0.0758292,
                            0.08473836,
                            0.0672397,
                            0.02405432,
                            0.0972505,
                            0.09033668,
                            0.03338503,
                            0.00997671,
                            0.08601812,
                            0.08988569,
                            0.01974867,
                            0.07537103,
                            0.044631,
                            0.01163534,
                            0.07778555,
                            0.00500877,
                            0.05604735,
                            0.06193424,
                            0.026859,
                            0.05198305,
                            0.05335228,
                            0.06338206,
                            0.07981056,
                            0.03128861,
                            0.00411518,
                            0.00500641,
                            0.08231421,
                            0.0835383,
                            0.02039181,
                            0.02134244,
                            0.08108945,
                            0.06373903,
                            0.05857015,
                            0.06034281,
                            0.08319761,
                            0.07588063,
                            0.0979415,
                            0.08503184,
                            0.05053136,
                            0.04204917,
                            0.00650433,
                            0.07961832,
                            0.06016469,
                            0.04312555,
                            0.02963368,
                            0.09109303,
                            0.01501264,
                            0.0021724,
                            0.08730843,
                            0.07497851,
                            0.08032175,
                            0.06144865,
                            0.07071516,
                            0.0361662,
                            0.0044735,
                            0.01776762,
                            0.04240971,
                            0.06001864,
                            0.03403537,
                            0.01691472,
                            0.0546236,
                        ]
                    )
                ],
                8, 4
            ),
        ],
    )
    def test_correctness(self, mps, state, num_wires, num_work_wires):
        """Test correctness of the solution

        Data was generated adapting the functionality `decompose_dense` in
        pennylane-lightning/pennylane_lightning/lightning_tensor/_tensornet.py
        """

        wires = qml.registers({"work": num_work_wires, "state": num_wires})
        dev = qml.device("default.qubit")

        @qml.qnode(dev)
        def circuit():
            qml.MPSPrep(mps, wires=wires["state"], work_wires=wires["work"])
            return qml.state()

        output = circuit()[: 2**num_wires]

        assert np.allclose(state, output, rtol=0.01)

    def test_decomposition(self):
        """Tests that the template defines the correct decomposition."""

        mps = [
            np.array([[0.70710678, 0.0], [0.0, 0.70710678]]),
            np.array(
                [
                    [[0.0, 1.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0]],
                    [[0.0, 0.0, -0.0, 0.0], [-1.0, 0.0, 0.0, 0.0]],
                ]
            ),
            np.array(
                [
                    [[0.00000000e00, 1.74315280e-32], [-7.07106781e-01, -7.07106781e-01]],
                    [[7.07106781e-01, 7.07106781e-01], [0.00000000e00, 0.00000000e00]],
                    [[0.00000000e00, 0.00000000e00], [-7.07106781e-01, 7.07106781e-01]],
                    [[-7.07106781e-01, 7.07106781e-01], [0.00000000e00, 0.00000000e00]],
                ]
            ),
            np.array([[1.0, 0.0], [0.0, 1.0]]),
        ]

        ops = qml.MPSPrep.compute_decomposition(mps, wires=range(2, 6), work_wires=[0, 1])

        for ind, op in enumerate(ops):
            assert op.wires == qml.wires.Wires([2 + ind] + [0, 1])
            assert op.name == "QubitUnitary"

    @pytest.mark.jax
    def test_jax_jit_mps(self):
        """Check the operation works with jax and jit."""

        import jax
        from jax import numpy as jnp

        mps = [
            jnp.array([[0.0, 0.107j], [0.994, 0.0]], dtype=complex),
            jnp.array(
                [
                    [[0.0, 0.0], [1.0, 0.0]],
                    [[0.0, 1.0], [0.0, 0.0]],
                ],
                dtype=complex,
            ),
            jnp.array([[-1.0, -0.0], [-0.0, -1.0]], dtype=complex),
        ]

        dev = qml.device("default.qubit")

        @jax.jit
        @qml.qnode(dev)
        def circuit():
            qml.MPSPrep(mps, wires=range(2, 5), work_wires=[0, 1])
            return qml.state()

        output = circuit()[:8]

        state = [
            0.0 + 0.0j,
            -0.10705513j,
            0.0 + 0.0j,
            0.0 + 0.0j,
            0.0 + 0.0j,
            0.0 + 0.0j,
            -0.99451217 + 0.0j,
            0.0 + 0.0j,
        ]

        assert jax.numpy.allclose(output, jax.numpy.array(state), rtol=0.01)

    def test_wires_decomposition(self):
        """Checks that error is shown if no `work_wires` are given in decomposition"""

        mps = [
            np.array([[0.0, 0.107j], [0.994, 0.0]], dtype=complex),
            np.array(
                [
                    [[0.0, 0.0], [1.0, 0.0]],
                    [[0.0, 1.0], [0.0, 0.0]],
                ],
                dtype=complex,
            ),
            np.array([[-1.0, -0.0], [-0.0, -1.0]], dtype=complex),
        ]

        dev = qml.device("default.qubit")

        @qml.qnode(dev)
        def circuit():
            qml.MPSPrep(mps, wires=range(2, 5))
            return qml.state()

        with pytest.raises(AssertionError, match="The qml.MPSPREP decomposition requires"):
            circuit()
