name: Install Dependencies
description: |
  This workflow installs Python, PennyLane and all its dependencies. If a
  requirements file is provided, it will upload the results of pip freeze
  as well.
inputs:
  python_version:
    description: The version of Python to use in order to run unit tests
    required: false
    default: '3.10'
  install_numpy_1:
    description: Indicate if numpy 1 should be installed or not
    required: false
    type: boolean
    default: false
  additional_pip_packages:
    description: |
      Additional packages to install. Values will be passed to pip install {value}. 
      Packages passed to this input can be space separated or on a newline each.
      All packages are installed PRIOR to installation of pennylane itself.
    required: false
    default: ''
  additional_pip_packages_post:
    description: |
      Additional packages to install. Values will be passed to pip install {value}. 
      Packages passed to this input can be space separated or on a newline each.
      All packages are installed AFTER installation of pennylane itself.
    required: false
    default: ''
  requirements_file:
    description: File name to store stable version of requirements for a test group
    required: false
    default: ''

runs:
  using: composite
  steps:
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '${{ inputs.python_version }}'

    - name: Upgrade PIP
      shell: bash
      run: pip install --upgrade pip && pip install wheel --upgrade

    - name: Install PennyLane dependencies
      shell: bash
      run: |
        pip install -r requirements-ci.txt --upgrade
        pip install -r requirements-dev.txt --upgrade

    - name: Install numpy 1 version
      shell: bash
      if: inputs.install_numpy_1 == 'true'
      run: pip install "numpy==1.26.4"  

    - name: Install additional PIP packages
      shell: bash
      if: inputs.additional_pip_packages != ''
      env:
        ADDITIONAL_PIP_PACKAGES: ${{ inputs.additional_pip_packages }}
      run: |
        while IFS= read -r line; do
          if [ ! -z "$line" ]; then
              pip install $line
          fi
        done <<< "$ADDITIONAL_PIP_PACKAGES"

    - name: Install PennyLane
      shell: bash
      run: |
        python setup.py bdist_wheel
        pip install dist/PennyLane*.whl
    
    - name: Install additional PIP packages (Post PennyLane Install)
      shell: bash
      if: inputs.additional_pip_packages_post != ''
      env:
        ADDITIONAL_PIP_PACKAGES: ${{ inputs.additional_pip_packages_post }}
      run: |
        while IFS= read -r line; do
          if [ ! -z "$line" ]; then
              pip install $line
          fi
        done <<< "$ADDITIONAL_PIP_PACKAGES"

    - name: Freeze dependencies
      shell: bash
      if: inputs.requirements_file != ''
      run: pip freeze | grep -v "file:///" | sed 's/\(pennylane[-_]lightning==[0-9\.]\+\)\.dev[0-9]\+/\1/gI' > ${{ inputs.requirements_file }}

    - name: Upload frozen requirements
      if: inputs.requirements_file != ''
      uses: actions/upload-artifact@v4
      with:
        name: frozen-${{ inputs.requirements_file }}
        path: ${{ inputs.requirements_file }}
